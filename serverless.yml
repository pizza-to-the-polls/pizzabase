service: pizzabase

frameworkVersion: "1"

plugins:
  - serverless-plugin-typescript
  - serverless-domain-manager

provider:
  name: aws
  runtime: nodejs12.x
  timeout: 300
  stage: prod
  region: us-west-2
  environment:
    SS_AUTH_ID: ${env:SS_AUTH_ID}
    SS_AUTH_TOKEN: ${env:SS_AUTH_TOKEN}
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - "secretsmanager:GetSecretValue"
        - "secretsmanager:PutResourcePolicy"
        - "secretsmanager:PutSecretValue"
        - "secretsmanager:DeleteSecret"
        - "secretsmanager:DescribeSecret"
        - "secretsmanager:TagResource"
      Resource:
        - "arn:aws:secretsmanager:*:*:secret:PizzaBase*"
    - Effect: "Allow"
      Action:
        - "secretsmanager:CreateSecret"
        - "secretsmanager:ListSecrets"
        - "secretsmanager:GetRandomPassword"
        - "tag:GetResources"
        - "rds-data:BatchExecuteStatement"
        - "rds-data:BeginTransaction"
        - "rds-data:CommitTransaction"
        - "rds-data:ExecuteStatement"
        - "rds-data:RollbackTransaction"
      Resource:
        - "*"

package:
  include:
    - ormconfig.json

functions:
  app:
    handler: src/lambda.handler
    events:
      - http: ANY /
      - http: "ANY {proxy+}"

custom:
  customDomain:
    domainName: base.polls.pizza
    basePath: ""
    stage: ${self:provider.stage}
    createRoute53Record: true
